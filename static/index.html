<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Arbitrage Scanner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Sticky first column (row numbers) */
    .sticky-col {
      position: sticky;
      left: 0;
      background-color: #1f2937; /* match dark theme */
      z-index: 2;
    }
    thead .sticky-col {
      z-index: 3; /* keep header above body */
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center p-4">
  <h1 class="text-2xl font-bold mb-4">Arbitrage Scanner</h1>

  <!-- Scan Controls -->
  <div class="w-full max-w-6xl mb-6">
    <h2 class="text-xl font-semibold mb-2">Scan Controls</h2>
    <div class="flex flex-col md:flex-row gap-3">
      <!-- Exchange Selection -->
      <select id="exchangeSelect" class="p-2 bg-gray-800 border border-gray-600 rounded">
        <option value="binance">Binance</option>
        <option value="bybit">Bybit</option>
        <option value="gateio">Gate.io</option>
        <option value="kucoin">Kucoin</option>
      </select>

      <!-- Minimum Profit Input -->
      <input id="minProfit" type="number" step="0.01" value="0"
             class="p-2 bg-gray-800 border border-gray-600 rounded"
             placeholder="Min Profit %">

      <!-- Collect Window Input -->
      <input id="collectWindow" type="number" step="1" value="5"
             class="p-2 bg-gray-800 border border-gray-600 rounded"
             placeholder="Collect Window (sec)">

      <!-- Scan Button -->
      <button id="scanBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded">
        Scan
      </button>
    </div>
  </div>

  <!-- Results Table -->
  <div id="resultsContainer" class="w-full max-w-6xl overflow-auto hidden" style="max-height: 400px;">
    <table class="table-auto border-collapse border border-gray-700 w-full">
      <thead class="bg-blue-600">
        <tr>
          <th class="sticky-col border border-gray-700 px-4 py-2">#</th>
          <th class="border border-gray-700 px-4 py-2">Triangle</th>
          <th class="border border-gray-700 px-4 py-2">Pairs</th>
          <th class="border border-gray-700 px-4 py-2">Profit % Before Fee</th>
          <th class="border border-gray-700 px-4 py-2">Fee</th>
          <th class="border border-gray-700 px-4 py-2">Profit % After Fee</th>
        </tr>
      </thead>
      <tbody id="resultsTable" class="divide-y divide-gray-700"></tbody>
    </table>
  </div>

  <script>
    document.getElementById("scanBtn").addEventListener("click", async () => {
      const exchange = document.getElementById("exchangeSelect").value;
      const minProfit = parseFloat(document.getElementById("minProfit").value) || 0;
      const collectWindow = parseInt(document.getElementById("collectWindow").value) || 5;

      const payload = {
        exchanges: [exchange],
        min_profit: minProfit,
        collect_seconds: collectWindow,
      };

      try {
        const res = await fetch("/scan", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        const tableBody = document.getElementById("resultsTable");
        tableBody.innerHTML = "";

        if (data.length > 0) {
          document.getElementById("resultsContainer").classList.remove("hidden");
          data.forEach((op, index) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td class="sticky-col border border-gray-700 px-4 py-2 bg-gray-900">${index + 1}</td>
              <td class="border border-gray-700 px-4 py-2">${op.triangle.join(" â†’ ")}</td>
              <td class="border border-gray-700 px-4 py-2">${op.pairs.base}/${op.pairs.quote}</td>
              <td class="border border-gray-700 px-4 py-2">${op.profit_before.toFixed(2)}%</td>
              <td class="border border-gray-700 px-4 py-2">${op.fees.toFixed(2)}%</td>
              <td class="border border-gray-700 px-4 py-2">${op.profit_after.toFixed(2)}%</td>
            `;
            tableBody.appendChild(row);
          });
        } else {
          document.getElementById("resultsContainer").classList.add("hidden");
          alert("No opportunities found.");
        }
      } catch (err) {
        console.error("Scan failed:", err);
        alert("Scan request failed.");
      }
    });
  </script>
</body>
    </html>
